import asyncio
import logging
import sqlite3
import re
import uuid
import sys
from datetime import datetime, timedelta
from pyrogram import Client, filters, idle
from pyrogram.types import Message, InlineKeyboardMarkup, InlineKeyboardButton, CallbackQuery, ChatPermissions
from pyrogram.errors import (
    PeerIdInvalid, UsernameInvalid, UserNotParticipant, 
    ChatAdminRequired, FloodWait, ChannelInvalid, 
    ChannelPrivate, UsernameNotOccupied
)

# ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

# ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Ğ±Ğ¾Ñ‚Ğ°
app = Client(
    "SHARK_bot",
    api_id=23258474,
    api_hash="f5dd3f52675030a650ca2259f9fb79ce",
    bot_token="8484896113:AAFWaHofoLQWr4eLAu0KdHy0sb0uym77Dvk",
    sleep_threshold=30
)

# Ğ’Ğ»Ğ°Ğ´ĞµĞ»ÑŒÑ†Ñ‹ Ğ±Ğ¾Ñ‚Ğ°
OWNERS = {
    "BACHHIRA": {
        "id": "7279068300",
        "username": "BachiraOFFICIAL"
    },
    "Ğ´ĞµĞ´ Ğ¼Ğ¾Ñ€Ğ¾Ğ·": {
        "id": "67676767",
        "username": "XYI"
    }
}

OWNER_PHOTO_PATH = "owner_card.png"

# Ğ˜Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ Ğ´Ğ»Ñ Ñ€Ğ¾Ğ»ĞµĞ¹
ROLE_IMAGES = {
    "ĞĞµÑ‚ Ğ² Ğ±Ğ°Ğ·Ğµ": "https://i.ibb.co/TDYJz0Jg/1000036395.jpg",
    "ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞµĞ½ Ğ³Ğ°Ñ€Ğ°Ğ½Ñ‚Ğ¾Ğ¼": "https://i.ibb.co/7tV1B8RX/1000036402.jpg",
    "Ğ¡ĞºĞ°Ğ¼Ğ¼ĞµÑ€": "https://i.ibb.co/CsQXwGxs/1000036406.jpg",
    "Ğ’Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ ÑĞºĞ°Ğ¼Ğ¼ĞµÑ€": "https://i.ibb.co/7dYZVrx5/IMG-20251215-180030-247.jpg",
    "Ğ“Ğ°Ñ€Ğ°Ğ½Ñ‚": "https://i.ibb.co/35vfpZ4c/IMG-20251215-180029-911.jpg",
    "Ğ¡Ñ‚Ğ°Ğ¶ĞµÑ€": "https://i.ibb.co/35vfpZ4c/IMG-20251215-180029-911.jpg",
    "ĞĞ´Ğ¼Ğ¸Ğ½": "https://i.ibb.co/35vfpZ4c/IMG-20251215-180029-911.jpg",
    "Ğ”Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€": "https://i.ibb.co/0y4wmkGD/IMG-20251215-180030-188.jpg",
    "ĞŸÑ€ĞµĞ·Ğ¸Ğ´ĞµĞ½Ñ‚": "https://i.ibb.co/4Zdx3sKL/IMG-20251215-180029-804.jpg",
    "Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ĞµĞ»ÑŒ": "https://i.ibb.co/4R6nWfbL/1000036399.jpg",
    "Ğ—Ğ°Ğ¼ĞµÑÑ‚Ğ¸Ñ‚ĞµĞ»ÑŒ": "https://i.ibb.co/35vfpZ4c/IMG-20251215-180029-911.jpg",
    "ĞšĞ¾Ğ´ĞµÑ€": "https://i.ibb.co/35vfpZ4c/IMG-20251215-180029-911.jpg",
    "ĞœĞ¾Ğ´ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€": "https://i.ibb.co/35vfpZ4c/IMG-20251215-180029-911.jpg",
    "Ğ”Ğ¸Ğ·Ğ°Ğ¹Ğ½ĞµÑ€": "https://i.ibb.co/35vfpZ4c/IMG-20251215-180029-911.jpg"
}

SCAM_RATING_OPTIONS = {
    1: {"text": "1 - Ğ’Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ ÑĞºĞ°Ğ¼", "chance": "70-80%", "role_name": "Ğ’Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ ÑĞºĞ°Ğ¼Ğ¼ĞµÑ€"},
    2: {"text": "2 - Ğ¡Ğ¾Ğ¼Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ñ€ĞµĞ¿ÑƒÑ‚Ğ°Ñ†Ğ¸Ñ", "chance": "59-65%", "role_name": "Ğ’Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ ÑĞºĞ°Ğ¼Ğ¼ĞµÑ€"},
    3: {"text": "3 - ĞŸĞµÑ‚ÑƒÑ…", "chance": "90-99%", "role_name": "Ğ¡ĞºĞ°Ğ¼Ğ¼ĞµÑ€"},
    4: {"text": "4 - Ğ¡ĞšĞĞœĞœĞ•Ğ ", "chance": "100%", "role_name": "Ğ¡ĞºĞ°Ğ¼Ğ¼ĞµÑ€"},
}

# Ğ›Ğ¸Ğ¼Ğ¸Ñ‚Ñ‹ Ğ¸ ĞºÑÑˆĞ¸
RATE_LIMITS = {}
CHECK_LIMIT_SECONDS = 5
PENDING_SCAM_ENTRIES = {}
MENTOR_REQUESTS = {}

STAFF_CACHE = {
    'admins': [], 'coders': [], 'employees': [], 'volunteers': [], 
    'moderators': [], 'directors': [], 'presidents': [], 'designers': []
}
USER_INFO_CACHE = {}

# Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
def init_database():
    """Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…"""
    conn = sqlite3.connect('SHARK_database.db', check_same_thread=False)
    cursor = conn.cursor()
    
    # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS scammers (
            user_id TEXT PRIMARY KEY, 
            reason TEXT, 
            proof_link TEXT, 
            scam_rating INTEGER DEFAULT 4
        )
    """)

    cursor.execute("CREATE TABLE IF NOT EXISTS presidents (user_id TEXT PRIMARY KEY)")
    cursor.execute("CREATE TABLE IF NOT EXISTS directors (user_id TEXT PRIMARY KEY)")
    cursor.execute("CREATE TABLE IF NOT EXISTS admins (user_id TEXT PRIMARY KEY)")
    cursor.execute("CREATE TABLE IF NOT EXISTS trusted (user_id TEXT PRIMARY KEY, guarantor_id TEXT)")
    cursor.execute("CREATE TABLE IF NOT EXISTS volunteers (user_id TEXT PRIMARY KEY)")
    cursor.execute("CREATE TABLE IF NOT EXISTS coders (user_id TEXT PRIMARY KEY)")
    cursor.execute("CREATE TABLE IF NOT EXISTS employees (user_id TEXT PRIMARY KEY)")
    cursor.execute("CREATE TABLE IF NOT EXISTS moderators (user_id TEXT PRIMARY KEY)")
    cursor.execute("CREATE TABLE IF NOT EXISTS designers (user_id TEXT PRIMARY KEY)")
    cursor.execute("CREATE TABLE IF NOT EXISTS reputation (user_id TEXT PRIMARY KEY, count INTEGER DEFAULT 0)")
    cursor.execute("CREATE TABLE IF NOT EXISTS user_settings (user_id TEXT PRIMARY KEY, country TEXT)")
    cursor.execute("CREATE TABLE IF NOT EXISTS reprimands (user_id TEXT PRIMARY KEY, count INTEGER DEFAULT 0)")
    cursor.execute("CREATE TABLE IF NOT EXISTS mentorship (volunteer_id TEXT PRIMARY KEY, mentor_id TEXT)")
    
    conn.commit()
    return conn, cursor

# Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ´Ğ»Ñ Ğ‘Ğ”
conn, cursor = init_database()

# Ğ’ÑĞ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸
def get_russian_date():
    """Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ñ‚ĞµĞºÑƒÑ‰ÑƒÑ Ğ´Ğ°Ñ‚Ñƒ Ğ½Ğ° Ñ€ÑƒÑÑĞºĞ¾Ğ¼ ÑĞ·Ñ‹ĞºĞµ"""
    months = ['ÑĞ½Ğ²Ğ°Ñ€Ñ', 'Ñ„ĞµĞ²Ñ€Ğ°Ğ»Ñ', 'Ğ¼Ğ°Ñ€Ñ‚Ğ°', 'Ğ°Ğ¿Ñ€ĞµĞ»Ñ', 'Ğ¼Ğ°Ñ', 'Ğ¸ÑĞ½Ñ', 
              'Ğ¸ÑĞ»Ñ', 'Ğ°Ğ²Ğ³ÑƒÑÑ‚Ğ°', 'ÑĞµĞ½Ñ‚ÑĞ±Ñ€Ñ', 'Ğ¾ĞºÑ‚ÑĞ±Ñ€Ñ', 'Ğ½Ğ¾ÑĞ±Ñ€Ñ', 'Ğ´ĞµĞºĞ°Ğ±Ñ€Ñ']
    now = datetime.now()
    return f"{now.day} {months[now.month - 1]} {now.year} | {now.strftime('%H:%M')}"

def get_clean_id(text):
    """ĞÑ‡Ğ¸Ñ‰Ğ°ĞµÑ‚ Ğ¸Ğ´ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€ Ğ¾Ñ‚ @ Ğ¸ Ğ»Ğ¸ÑˆĞ½Ğ¸Ñ… Ğ¿Ñ€Ğ¾Ğ±ĞµĞ»Ğ¾Ğ²"""
    if text:
        return text.lstrip("@").strip()
    return ""

def is_owner(user_id, username):
    """ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚, ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ»Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ²Ğ»Ğ°Ğ´ĞµĞ»ÑŒÑ†ĞµĞ¼"""
    user_id_str = str(user_id)
    username_lower = username.lower() if username else None
    
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ğ¾ ID
    for owner_name, owner_data in OWNERS.items():
        if owner_data["id"] == user_id_str:
            return True
    
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ğ¾ username
    if username_lower:
        for owner_name, owner_data in OWNERS.items():
            if owner_data["username"] and owner_data["username"].lower() == username_lower:
                return True
    
    return False

def is_president(user_id):
    cursor.execute("SELECT 1 FROM presidents WHERE user_id = ?", (str(user_id),))
    return cursor.fetchone() is not None

def is_director(user_id):
    cursor.execute("SELECT 1 FROM directors WHERE user_id = ?", (str(user_id),))
    return cursor.fetchone() is not None

def is_admin(user_id):
    cursor.execute("SELECT 1 FROM admins WHERE user_id = ?", (str(user_id),))
    return cursor.fetchone() is not None

def is_coder(user_id):
    cursor.execute("SELECT 1 FROM coders WHERE user_id = ?", (str(user_id),))
    return cursor.fetchone() is not None

def is_employee(user_id):
    cursor.execute("SELECT 1 FROM employees WHERE user_id = ?", (str(user_id),))
    return cursor.fetchone() is not None

def is_moderator(user_id): 
    cursor.execute("SELECT 1 FROM moderators WHERE user_id = ?", (str(user_id),))
    return cursor.fetchone() is not None

def is_designer(user_id):
    cursor.execute("SELECT 1 FROM designers WHERE user_id = ?", (str(user_id),))
    return cursor.fetchone() is not None

def is_volunteer(user_id):
    cursor.execute("SELECT 1 FROM volunteers WHERE user_id = ?", (str(user_id),))
    return cursor.fetchone() is not None

def get_all_moderators():
    cursor.execute("SELECT user_id FROM moderators")
    return [row[0] for row in cursor.fetchall()]

def is_full_staff(user_id, username):
    """ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ (Ğ²Ğ»Ğ°Ğ´ĞµĞ»ĞµÑ†, Ğ¿Ñ€ĞµĞ·Ğ¸Ğ´ĞµĞ½Ñ‚, ĞºĞ¾Ğ´ĞµÑ€, Ğ°Ğ´Ğ¼Ğ¸Ğ½)"""
    if is_owner(user_id, username): 
        return True
    if is_president(user_id): 
        return True
    if is_coder(user_id): 
        return True
    return is_admin(user_id)

def can_moderate(user_id, username):
    """ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ Ğ¿Ñ€Ğ°Ğ²Ğ° Ğ½Ğ° Ğ¼Ğ¾Ğ´ĞµÑ€Ğ°Ñ†Ğ¸Ñ"""
    if is_full_staff(user_id, username): 
        return True
    if is_director(user_id): 
        return True
    return is_employee(user_id)

def can_temp_moderate(user_id, username):
    """ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ° Ğ½Ğ° Ğ¼Ğ¾Ğ´ĞµÑ€Ğ°Ñ†Ğ¸Ñ"""
    if can_moderate(user_id, username): 
        return True
    if is_volunteer(user_id): 
        return True
    return is_moderator(user_id)

def is_any_staff(user_id, username=None):
    """ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚, ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ»Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ»ÑĞ±Ñ‹Ğ¼ ÑĞ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸ĞºĞ¾Ğ¼"""
    if username and is_owner(user_id, username): 
        return True
    if is_president(user_id): 
        return True
    if is_director(user_id): 
        return True
    if is_admin(user_id) or is_coder(user_id) or is_employee(user_id) or is_moderator(user_id) or is_volunteer(user_id) or is_designer(user_id):
        return True
    return False

def get_reputation(user_id):
    cursor.execute("SELECT count FROM reputation WHERE user_id = ?", (str(user_id),))
    res = cursor.fetchone()
    return res[0] if res else 0

def db_increment_reputation(user_id):
    cursor.execute("""
        INSERT INTO reputation (user_id, count) VALUES (?, 1) 
        ON CONFLICT(user_id) DO UPDATE SET count = count + 1
    """, (str(user_id),))
    conn.commit()

def set_mentor(volunteer_id, mentor_id):
    cursor.execute("INSERT OR REPLACE INTO mentorship (volunteer_id, mentor_id) VALUES (?, ?)", 
                   (str(volunteer_id), str(mentor_id)))
    conn.commit()

def get_mentor_id(volunteer_id):
    cursor.execute("SELECT mentor_id FROM mentorship WHERE volunteer_id = ?", (str(volunteer_id),))
    res = cursor.fetchone()
    return res[0] if res else None

def get_reprimands_count(user_id):
    cursor.execute("SELECT count FROM reprimands WHERE user_id = ?", (str(user_id),))
    res = cursor.fetchone()
    return res[0] if res else 0

def add_reprimand(user_id):
    cursor.execute("""
        INSERT INTO reprimands (user_id, count) VALUES (?, 1) 
        ON CONFLICT(user_id) DO UPDATE SET count = count + 1
    """, (str(user_id),))
    conn.commit()
    return get_reprimands_count(user_id)

def clear_reprimands(user_id):
    cursor.execute("DELETE FROM reprimands WHERE user_id = ?", (str(user_id),))
    conn.commit()

def remove_all_staff_roles(user_id):
    """Ğ£Ğ´Ğ°Ğ»ÑĞµÑ‚ Ğ²ÑĞµ Ñ€Ğ¾Ğ»Ğ¸ ÑĞ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸ĞºĞ°"""
    tables = ['presidents', 'directors', 'admins', 'coders', 'moderators', 'employees', 'volunteers', 'designers']
    for table in tables:
        cursor.execute(f"DELETE FROM {table} WHERE user_id = ?", (str(user_id),))
    conn.commit()

def db_set_country(user_id, country_text):
    cursor.execute("INSERT OR REPLACE INTO user_settings (user_id, country) VALUES (?, ?)", 
                   (str(user_id), country_text))
    conn.commit()

def db_get_country(user_id):
    cursor.execute("SELECT country FROM user_settings WHERE user_id = ?", (str(user_id),))
    res = cursor.fetchone()
    return res[0] if res else "Unknown"

def db_add_scammer_final(user_id, reason, proof_link, scam_rating):
    try:
        cursor.execute("""
            INSERT OR REPLACE INTO scammers (user_id, reason, proof_link, scam_rating) 
            VALUES (?, ?, ?, ?)
        """, (str(user_id), reason, proof_link, scam_rating))
        conn.commit()
        return True
    except Exception as e:
        logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸ ÑĞºĞ°Ğ¼Ğ¼ĞµÑ€Ğ°: {e}")
        return False

def db_delete(table, user_id):
    cursor.execute(f"DELETE FROM {table} WHERE user_id = ?", (str(user_id),))
    conn.commit()
    return cursor.rowcount > 0

async def get_message_link(client, message):
    """Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ ÑÑÑ‹Ğ»ĞºÑƒ Ğ½Ğ° ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ"""
    try:
        chat_id = message.chat.id
        message_id = message.id
        if message.chat.username:
            return f"https://t.me/{message.chat.username}/{message_id}"
        else:
            raw_chat_id = str(chat_id).replace('-100', '')
            return f"https://t.me/c/{raw_chat_id}/{message_id}"
    except Exception as e:
        logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ ÑÑÑ‹Ğ»ĞºĞ¸ Ğ½Ğ° ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ: {e}")
        return f"(Ğ¡ÑÑ‹Ğ»ĞºĞ° Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ°, ID Ñ‡Ğ°Ñ‚Ğ°: {message.chat.id})"

async def get_guarantor_link(client, target_id):
    """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ ÑÑÑ‹Ğ»ĞºÑƒ Ğ½Ğ° Ğ³Ğ°Ñ€Ğ°Ğ½Ñ‚Ğ°"""
    cursor.execute("SELECT guarantor_id FROM trusted WHERE user_id = ?", (str(target_id),))
    res = cursor.fetchone()
    if not res or not res[0]:
        return None
    
    guarantor_id = res[0]
    try:
        guarantor_info = await client.get_users(int(guarantor_id))
        name = guarantor_info.first_name
        username = guarantor_info.username
        
        if username:
            link = f"https://t.me/{username}"
            display_name = f"**{name}** (@{username})"
        else:
            link = f"tg://user?id={guarantor_id}"
            display_name = f"**{name}** (ID: {guarantor_id})"
        
        return f"ğŸ’  **ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞµĞ½ Ğ³Ğ°Ñ€Ğ°Ğ½Ñ‚Ğ¾Ğ¼:** [Ğ“Ğ°Ñ€Ğ°Ğ½Ñ‚ {display_name}]({link})"
    except Exception as e:
        logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¾ Ğ³Ğ°Ñ€Ğ°Ğ½Ñ‚Ğµ: {e}")
        return None

async def get_mentor_link(client, volunteer_id):
    """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ ÑÑÑ‹Ğ»ĞºÑƒ Ğ½Ğ° ĞºÑƒÑ€Ğ°Ñ‚Ğ¾Ñ€Ğ°"""
    mentor_id = get_mentor_id(volunteer_id)
    if not mentor_id:
        return None
    
    try:
        mentor_info = await client.get_users(int(mentor_id))
        name = mentor_info.first_name
        username = mentor_info.username
        
        if username:
            link = f"https://t.me/{username}"
            display_name = f"**{name}** (@{username})"
        else:
            link = f"tg://user?id={mentor_id}"
            display_name = f"**{name}** (ID: {mentor_id})"

        return f"\nğŸ“ **ĞšÑƒÑ€Ğ°Ñ‚Ğ¾Ñ€:** [ĞšÑƒÑ€Ğ°Ñ‚Ğ¾Ñ€ {display_name}]({link})"
    except Exception as e:
        logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¾ ĞºÑƒÑ€Ğ°Ñ‚Ğ¾Ñ€Ğµ: {e}")
        return None

def determine_user_role(user_id, username):
    """ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµÑ‚ Ñ€Ğ¾Ğ»ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ´Ğ»Ñ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ"""
    if is_owner(user_id, username):
        return "Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ĞµĞ»ÑŒ"
    elif is_president(user_id):
        return "ĞŸÑ€ĞµĞ·Ğ¸Ğ´ĞµĞ½Ñ‚"
    elif is_director(user_id):
        return "Ğ”Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€"
    elif is_admin(user_id):
        return "ĞĞ´Ğ¼Ğ¸Ğ½"
    elif is_coder(user_id):
        return "ĞšĞ¾Ğ´ĞµÑ€"
    elif is_designer(user_id):
        return "Ğ”Ğ¸Ğ·Ğ°Ğ¹Ğ½ĞµÑ€"
    elif is_employee(user_id):
        return "Ğ—Ğ°Ğ¼ĞµÑÑ‚Ğ¸Ñ‚ĞµĞ»ÑŒ"
    elif is_moderator(user_id):
        return "ĞœĞ¾Ğ´ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€"
    elif is_volunteer(user_id):
        return "Ğ¡Ñ‚Ğ°Ğ¶ĞµÑ€"
    elif cursor.execute("SELECT 1 FROM trusted WHERE user_id = ?", (str(user_id),)).fetchone():
        return "ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞµĞ½ Ğ³Ğ°Ñ€Ğ°Ğ½Ñ‚Ğ¾Ğ¼"
    elif cursor.execute("SELECT 1 FROM scammers WHERE user_id = ?", (str(user_id),)).fetchone():
        scam_data = cursor.execute("SELECT scam_rating FROM scammers WHERE user_id = ?", (str(user_id),)).fetchone()
        if scam_data and scam_data[0] is not None:
            rating = scam_data[0]
            if rating in [3, 4]:
                return "Ğ¡ĞºĞ°Ğ¼Ğ¼ĞµÑ€"
            elif rating in [1, 2]:
                return "Ğ’Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ ÑĞºĞ°Ğ¼Ğ¼ĞµÑ€"
    return "ĞĞµÑ‚ Ğ² Ğ±Ğ°Ğ·Ğµ"

def generate_card_text(t_id, t_username, t_name, guarantor_link=None, mentor_link=None):
    """Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ Ñ‚ĞµĞºÑÑ‚ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ"""
    t_id = str(t_id)
    country = db_get_country(t_id)
    is_owner_flag = is_owner(t_id, t_username)
    is_president_flag = is_president(t_id)
    is_coder_flag = is_coder(t_id)
    is_director_flag = is_director(t_id)
    is_admin_flag = is_admin(t_id)
    is_employee_flag = is_employee(t_id)
    is_moderator_flag = is_moderator(t_id)
    is_volunteer_flag = is_volunteer(t_id)
    is_designer_flag = is_designer(t_id)
    
    staff_label = ""
    reprimand_text = ""
    trusted_label = ""
    mentor_label = ""

    if is_any_staff(t_id, t_username):
        count = get_reprimands_count(t_id)
        reprimand_text = f"\nâš ï¸ **ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ²Ñ‹Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ¾Ğ²:** {count}/3"
    
    scam_data = cursor.execute("SELECT reason, proof_link, scam_rating FROM scammers WHERE user_id = ?", (t_id,)).fetchone()
    
    if scam_data:
        reason = scam_data[0] or "ĞœĞ¾ÑˆĞµĞ½Ğ½Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾"
        proof_link = scam_data[1]
        scam_rating = scam_data[2] if scam_data[2] is not None else 4
        rating_info = SCAM_RATING_OPTIONS.get(scam_rating, SCAM_RATING_OPTIONS[4])
        status, chance, color, footer = rating_info["text"], rating_info["chance"], "âŒ", f"âš ï¸ ĞŸĞ Ğ˜Ğ§Ğ˜ĞĞ: {reason}"
        if proof_link:
            footer += f"\nğŸ”— **Ğ”ĞĞšĞĞ—ĞĞ¢Ğ•Ğ›Ğ¬Ğ¡Ğ¢Ğ’Ğ:** [ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ ÑƒĞ²Ğ¸Ğ´ĞµÑ‚ÑŒ Ğ¿Ñ€ÑƒÑ„Ñ‹]({proof_link})"
    elif is_owner_flag:
        # ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ Ğ¸Ğ¼Ñ Ğ²Ğ»Ğ°Ğ´ĞµĞ»ÑŒÑ†Ğ° Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ
        owner_name = None
        for name, data in OWNERS.items():
            if data["id"] == t_id or (data["username"] and data["username"].lower() == str(t_username).lower()):
                owner_name = name
                break
        
        status, chance, color, footer = "Ğ’Ğ»Ğ°Ğ´ĞµĞ»ĞµÑ† ğŸ‘‘", "0%", "âœ…", "Ğ”Ğ¾Ğ²ĞµÑ€ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ²Ğ»Ğ°Ğ´ĞµĞ»ĞµÑ† SHARK."
        t_name = owner_name or t_name
        t_id = OWNERS.get(owner_name, {}).get("id", t_id)
    elif is_president_flag:
        status, chance, color, footer = "ĞŸÑ€ĞµĞ·Ğ¸Ğ´ĞµĞ½Ñ‚ ğŸ‘‘", "0%", "âœ…", "Ğ’Ñ‹ÑÑˆĞ°Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¸Ğ²Ğ½Ğ°Ñ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ."
    elif is_coder_flag:
        status, chance, color, footer = "ĞšĞ¾Ğ´ĞµÑ€ ğŸ’»", "0%", "âœ…", "Ğ Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº Ğ¿Ğ»Ğ°Ñ‚Ñ„Ğ¾Ñ€Ğ¼Ñ‹."
    elif is_designer_flag:
        status, chance, color, footer = "Ğ”Ğ¸Ğ·Ğ°Ğ¹Ğ½ĞµÑ€ ğŸ¨", "0%", "âœ…", "Ğ”Ğ¸Ğ·Ğ°Ğ¹Ğ½ĞµÑ€ Ğ¿Ğ»Ğ°Ñ‚Ñ„Ğ¾Ñ€Ğ¼Ñ‹."
    elif is_director_flag:
        status, chance, color, footer = "Ğ”Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€ ğŸ¯", "0%", "âœ…", "Ğ ÑƒĞºĞ¾Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°."
    elif is_admin_flag:
        status, chance, color, footer = "Ğ“Ğ°Ñ€Ğ°Ğ½Ñ‚ SHARK ğŸ›¡", "0%", "âœ…", "ĞÑ„Ğ¸Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ³Ğ°Ñ€Ğ°Ğ½Ñ‚ ÑĞµÑ€Ğ²Ğ¸ÑĞ° SHARK."
    elif is_employee_flag:
        status, chance, color, footer = "Ğ¡Ğ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸Ğº SHARK ğŸ’¼", "1-5%", "âœ…", "Ğ¡Ğ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸Ğº ÑĞµÑ€Ğ²Ğ¸ÑĞ°, Ğ¸Ğ¼ĞµĞµÑ‚ Ğ¿Ñ€Ğ°Ğ²Ğ¾ Ğ¼Ğ¾Ğ´ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸."
        staff_label = " âœ… [ĞŸĞµÑ€ÑĞ¾Ğ½Ğ°Ğ» Ğ±Ğ°Ğ·Ñ‹]"
    elif is_moderator_flag:
        status, chance, color, footer = "ĞœĞ¾Ğ´ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€ SHARK ğŸ”¨", "15-30%", "âœ…", "Ğ¡Ğ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸Ğº, ÑĞ»ĞµĞ´ÑÑ‰Ğ¸Ğ¹ Ğ·Ğ° Ğ¿Ğ¾Ñ€ÑĞ´ĞºĞ¾Ğ¼ Ğ² Ñ‡Ğ°Ñ‚Ğ°Ñ…."
        staff_label = " âœ… [ĞŸĞµÑ€ÑĞ¾Ğ½Ğ°Ğ» Ğ±Ğ°Ğ·Ñ‹]"
    elif is_volunteer_flag:
        status, chance, color, footer = "Ğ’Ğ¾Ğ»Ğ¾Ğ½Ñ‚ĞµÑ€ (Ğ¡Ñ‚Ğ°Ğ¶ĞµÑ€) ğŸ©", "5-15%", "âœ…", "ĞÑ„Ğ¸Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ²Ğ¾Ğ»Ğ¾Ğ½Ñ‚ĞµÑ€ ÑĞµÑ€Ğ²Ğ¸ÑĞ°."
        staff_label = " âœ… [ĞŸĞµÑ€ÑĞ¾Ğ½Ğ°Ğ» Ğ±Ğ°Ğ·Ñ‹]"
    elif cursor.execute("SELECT 1 FROM trusted WHERE user_id = ?", (t_id,)).fetchone():
        status, chance, color, footer = "ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞµĞ½ Ğ³Ğ°Ñ€Ğ°Ğ½Ñ‚Ğ¾Ğ¼ ğŸ’ ", "10-25%", "âœ…", "ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¸Ğ¼ĞµĞµÑ‚ Ğ´Ğ¾Ğ²ĞµÑ€Ğ¸Ğµ ÑĞµÑ€Ğ²Ğ¸ÑĞ°."
        if guarantor_link:
            trusted_label = f"\n{guarantor_link}"
    else:
        status, chance, color, footer = "ĞĞµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ Ğ² Ğ±Ğ°Ğ·Ğµ ğŸ‘¤", "40-50%", "âš ï¸", "Ğ§ĞµĞ»Ğ¾Ğ²ĞµĞºĞ° Ğ½ĞµÑ‚ Ğ² Ğ±Ğ°Ğ·Ğµ (Ğ Ğ¸ÑĞº Ğ¿Ñ€Ğ¸ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚)."

    if is_volunteer_flag and mentor_link:
        mentor_label = mentor_link

    leaked = get_reputation(t_id)
    display_link = f"@{t_username}" if t_username else "ĞĞµÑ‚ ÑĞ·ĞµÑ€Ğ½ĞµĞ¹Ğ¼Ğ°"
    
    if is_owner_flag and country == "Unknown":
        country = "Azerbaijan ğŸ‡¦ğŸ‡¿"
    
    id_display = f"[`{t_id}`]"

    text = (
        f"ğŸ‘¤ **{t_name}** | {display_link} | {id_display}\n\n"
        f"{color} **Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ:** {status}\n"
        f"ğŸ“‰ **Ğ¨Ğ°Ğ½Ñ ÑĞºĞ°Ğ¼Ğ°:** {chance}{staff_label}{reprimand_text}{trusted_label}{mentor_label}\n"
        f"ğŸŒ **Ğ¡Ñ‚Ñ€Ğ°Ğ½Ğ°:** {country}\n"
        f"ğŸš« **Ğ¡ĞºĞ°Ğ¼Ğ¼ĞµÑ€Ğ¾Ğ² ÑĞ»Ğ¸Ñ‚Ğ¾:** {leaked}\n\n"
        f"{footer}\n"
        f"Ğ’ÑĞµĞ³Ğ´Ğ° Ğ¸Ğ´Ğ¸Ñ‚Ğµ Ñ‡ĞµÑ€ĞµĞ· Ğ³Ğ°Ñ€Ğ°Ğ½Ñ‚Ğ¾Ğ² **SHARK**, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ ÑĞ´ĞµĞ»ĞºĞ¸ Ğ¿Ñ€Ğ¾Ñ…Ğ¾Ğ´Ğ¸Ğ»Ğ¸ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾.\n\n"
        f"ğŸ“… {get_russian_date()} | ğŸ¤– @SHARKBOT_ANTISCAMBOT"
    )
    
    # ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ Ñ€Ğ¾Ğ»ÑŒ Ğ´Ğ»Ñ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ
    role = determine_user_role(t_id, t_username)
    image_url = ROLE_IMAGES.get(role, ROLE_IMAGES["ĞĞµÑ‚ Ğ² Ğ±Ğ°Ğ·Ğµ"])
    
    # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑĞºÑ€Ñ‹Ñ‚ÑƒÑ ÑÑÑ‹Ğ»ĞºÑƒ Ğ½Ğ° Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ Ğ² Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ¾ Ñ‚ĞµĞºÑÑ‚Ğ°
    text_with_image = f"[â ]({image_url})" + text
    
    return text_with_image, is_owner_flag, role

def get_profile_keyboard(user_id, username):
    """Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ñƒ Ñ ÑÑÑ‹Ğ»ĞºĞ¾Ğ¹ Ğ½Ğ° Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ"""
    if username:
        url = f"https://t.me/{username}"
    else:
        url = f"tg://user?id={user_id}"
    return InlineKeyboardMarkup([[InlineKeyboardButton("ğŸ”— ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ", url=url)]])

async def find_target(client, message, arg_text=None):
    """ĞĞ°Ñ…Ğ¾Ğ´Ğ¸Ñ‚ Ñ†ĞµĞ»ÑŒ Ğ¿Ğ¾ ID Ğ¸Ğ»Ğ¸ ÑĞ·ĞµÑ€Ğ½ĞµĞ¹Ğ¼Ñƒ"""
    try:
        if message.reply_to_message and message.reply_to_message.from_user:
            return message.reply_to_message.from_user, None
        
        if not arg_text:
            return None, None
        
        clean = get_clean_id(arg_text)
        if clean.lower() in ["Ğ¼Ğ¸", "me", "Ñ"]:
            return message.from_user, None

        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ĞºÑÑˆĞ°
        if clean.isdigit() and str(clean) in USER_INFO_CACHE:
            cached_info = USER_INFO_CACHE[str(clean)]
            class CachedUser:
                id = cached_info['id']
                username = cached_info.get('username')
                first_name = cached_info['name']
                is_bot = False
            return CachedUser(), None

        # ĞŸĞ¾Ğ¿Ñ‹Ñ‚ĞºĞ° Ğ½Ğ°Ğ¹Ñ‚Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
        try:
            if clean.isdigit():
                chat = await client.get_users(int(clean))
            else:
                # Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ @ ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ
                username_clean = clean.lstrip('@')
                chat = await client.get_users(username_clean)
            
            if chat:
                USER_INFO_CACHE[str(chat.id)] = {
                    'id': str(chat.id),
                    'name': chat.first_name,
                    'username': chat.username
                }
            
            return chat, None
        except (UsernameInvalid, UsernameNotOccupied):
            return None, clean
        except (PeerIdInvalid, ChannelInvalid, ChannelPrivate):
            return None, clean
        except Exception as e:
            logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ¾Ğ¸ÑĞºĞ° Ñ†ĞµĞ»Ğ¸: {e}")
            return None, clean
            
    except Exception as e:
        logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ² Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ find_target: {e}")
        return None, None

# ĞšĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ñ‹
def main_menu_keyboard():
    """Ğ“Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ"""
    return InlineKeyboardMarkup([
        [InlineKeyboardButton("ĞœĞ¾Ğ¹ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ â„¹ï¸", callback_data="my_profile")],
        [
            InlineKeyboardButton("Ğ¡Ğ»Ğ¸Ñ‚ÑŒ ÑĞºĞ°Ğ¼Ğ¼ĞµÑ€Ğ° ğŸ˜¡", callback_data="report_scam"),
            InlineKeyboardButton("Ğ§Ğ°ÑÑ‚Ñ‹Ğµ Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹ â“", callback_data="faq")
        ],
        [
            InlineKeyboardButton("Ğ“Ğ°Ñ€Ğ°Ğ½Ñ‚Ñ‹ ğŸ”¥", callback_data="list_admins"),
            InlineKeyboardButton("Ğ”Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ° ğŸ¯", callback_data="list_directors"),
            InlineKeyboardButton("ĞŸÑ€ĞµĞ·Ğ¸Ğ´ĞµĞ½Ñ‚Ñ‹ ğŸ‘‘", callback_data="list_presidents"),
            InlineKeyboardButton("Ğ¡Ğ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸ĞºĞ¸ ğŸ’¼", callback_data="list_employees")
        ],
        [
            InlineKeyboardButton("ĞœĞ¾Ğ´ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€Ñ‹ ğŸ”¨", callback_data="list_moderators"),
            InlineKeyboardButton("Ğ’Ğ¾Ğ»Ğ¾Ğ½Ñ‚Ñ‘Ñ€Ñ‹ ğŸŒ´", callback_data="list_volunteers"),
            InlineKeyboardButton("Ğ”Ğ¸Ğ·Ğ°Ğ¹Ğ½ĞµÑ€Ñ‹ ğŸ¨", callback_data="list_designers")
        ],
        [
            InlineKeyboardButton("Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° ğŸ“Š", callback_data="stats"),
            InlineKeyboardButton("ĞŸÑ€ĞµĞ¼Ğ¸ÑƒĞ¼ ğŸŒ¸", callback_data="premium")
        ]
    ])

def select_country_keyboard():
    """ĞšĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ğ° Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ñ‹"""
    return InlineKeyboardMarkup([
        [
            InlineKeyboardButton("ğŸ‡·ğŸ‡º Ğ Ğ¾ÑÑĞ¸Ñ", callback_data="country_Russia ğŸ‡·ğŸ‡º"),
            InlineKeyboardButton("ğŸ‡ºğŸ‡¦ Ğ£ĞºÑ€Ğ°Ğ¸Ğ½Ğ°", callback_data="country_Ukraine ğŸ‡ºğŸ‡¦")
        ],
        [
            InlineKeyboardButton("ğŸ‡§ğŸ‡¾ Ğ‘ĞµĞ»Ğ°Ñ€ÑƒÑÑŒ", callback_data="country_Belarus ğŸ‡§ğŸ‡¾"),
            InlineKeyboardButton("ğŸ‡°ğŸ‡¿ ĞšĞ°Ğ·Ğ°Ñ…ÑÑ‚Ğ°Ğ½", callback_data="country_Kazakhstan ğŸ‡°ğŸ‡¿")
        ],
        [
            InlineKeyboardButton("ğŸ‡©ğŸ‡ª Ğ“ĞµÑ€Ğ¼Ğ°Ğ½Ğ¸Ñ", callback_data="country_Germany ğŸ‡©ğŸ‡ª"),
            InlineKeyboardButton("ğŸ‡«ğŸ‡· Ğ¤Ñ€Ğ°Ğ½Ñ†Ğ¸Ñ", callback_data="country_France ğŸ‡«ğŸ‡·")
        ],
        [
            InlineKeyboardButton("ğŸ‡µğŸ‡± ĞŸĞ¾Ğ»ÑŒÑˆĞ°", callback_data="country_Poland ğŸ‡µğŸ‡±"),
            InlineKeyboardButton("ğŸ‡ºğŸ‡¸ Ğ¡Ğ¨Ğ", callback_data="country_USA ğŸ‡ºğŸ‡¸")
        ],
        [
            InlineKeyboardButton("ğŸ‡¦ğŸ‡¿ ĞĞ·ĞµÑ€Ğ±Ğ°Ğ¹Ğ´Ğ¶Ğ°Ğ½", callback_data="country_Azerbaijan ğŸ‡¦ğŸ‡¿"),
            InlineKeyboardButton("ğŸ³ï¸ Ğ¡ĞºÑ€Ñ‹Ñ‚ÑŒ", callback_data="country_Unknown")
        ],
        [InlineKeyboardButton("ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´ Ğ² Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ", callback_data="my_profile")]
    ])

def back_to_menu_keyboard():
    """ĞšĞ½Ğ¾Ğ¿ĞºĞ° Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğ° Ğ² Ğ¼ĞµĞ½Ñ"""
    return InlineKeyboardMarkup([[InlineKeyboardButton("ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´", callback_data="back_to_menu")]])

def get_scam_rating_keyboard():
    """ĞšĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ğ° Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° Ñ€ĞµĞ¹Ñ‚Ğ¸Ğ½Ğ³Ğ° ÑĞºĞ°Ğ¼Ğ°"""
    buttons = []
    for rating, data in SCAM_RATING_OPTIONS.items():
        buttons.append([InlineKeyboardButton(f"{data['text']} ({data['chance']})", 
                       callback_data=f"set_scam_rating_{rating}")])
    return InlineKeyboardMarkup(buttons)

def staff_list_keyboard():
    """ĞšĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ğ° Ğ´Ğ»Ñ ÑĞ¿Ğ¸ÑĞºĞ¾Ğ² Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»Ğ°"""
    return InlineKeyboardMarkup([
        [
            InlineKeyboardButton("ğŸ‘‘ ĞŸÑ€ĞµĞ·Ğ¸Ğ´ĞµĞ½Ñ‚Ñ‹", callback_data="list_presidents"),
            InlineKeyboardButton("ğŸ¯ Ğ”Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ°", callback_data="list_directors")
        ],
        [
            InlineKeyboardButton("ğŸ”¥ Ğ“Ğ°Ñ€Ğ°Ğ½Ñ‚Ñ‹", callback_data="list_admins"),
            InlineKeyboardButton("ğŸ’¼ Ğ¡Ğ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸ĞºĞ¸", callback_data="list_employees")
        ],
        [
            InlineKeyboardButton("ğŸ”¨ ĞœĞ¾Ğ´ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€Ñ‹", callback_data="list_moderators"),
            InlineKeyboardButton("ğŸŒ´ Ğ’Ğ¾Ğ»Ğ¾Ğ½Ñ‚ĞµÑ€Ñ‹", callback_data="list_volunteers")
        ],
        [
            InlineKeyboardButton("ğŸ’» ĞšĞ¾Ğ´ĞµÑ€Ñ‹", callback_data="list_coders"),
            InlineKeyboardButton("ğŸ¨ Ğ”Ğ¸Ğ·Ğ°Ğ¹Ğ½ĞµÑ€Ñ‹", callback_data="list_designers")
        ],
        [InlineKeyboardButton("ğŸ”™ Ğ“Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ", callback_data="back_to_menu")]
    ])

async def fetch_staff_info():
    """Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµÑ‚ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»Ğµ"""
    staff_tables = ['admins', 'coders', 'employees', 'volunteers', 
                   'moderators', 'directors', 'presidents', 'designers']
    
    for table in staff_tables:
        cursor.execute(f"SELECT user_id FROM {table}")
        user_ids = [row[0] for row in cursor.fetchall()]
        STAFF_CACHE[table] = []

        for user_id in user_ids:
            try:
                user_info = await app.get_users(int(user_id))
                info = {
                    'id': user_id,
                    'name': user_info.first_name,
                    'username': user_info.username
                }
                STAFF_CACHE[table].append(info)
                USER_INFO_CACHE[user_id] = info
            except Exception as e:
                logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğµ {user_id}: {e}")
                STAFF_CACHE[table].append({
                    'id': user_id,
                    'name': f"ID: {user_id}",
                    'username': None
                })

def parse_time(time_str):
    """ĞŸĞ°Ñ€ÑĞ¸Ñ‚ Ğ²Ñ€ĞµĞ¼Ñ Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ 30m, 2h, 1d"""
    if not time_str:
        return None, "ĞĞµ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ¾ Ğ²Ñ€ĞµĞ¼Ñ."
    
    time_str = time_str.lower()
    match = re.match(r"(\d+)([smhd])", time_str)
    if not match:
        return None, "ĞÑˆĞ¸Ğ±ĞºĞ° Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ°. Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ: 30s, 5m, 2h, 1d"
    
    value = int(match.group(1))
    unit = match.group(2)
    
    if unit == 's':
        delta = timedelta(seconds=value)
    elif unit == 'm':
        delta = timedelta(minutes=value)
    elif unit == 'h':
        delta = timedelta(hours=value)
    elif unit == 'd':
        delta = timedelta(days=value)
    else:
        return None, "ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ°Ñ ĞµĞ´Ğ¸Ğ½Ğ¸Ñ†Ğ° Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸."
    
    return datetime.now() + delta, None

# ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ Ğ±Ğ¾Ñ‚Ğ°
@app.on_message(filters.command("start") & filters.private)
async def start_cmd(client, message):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ /start"""
    await message.reply(
        "ğŸ‘‹ **Ğ”Ğ¾Ğ±Ñ€Ğ¾ Ğ¿Ğ¾Ğ¶Ğ°Ğ»Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ² SHARK AntiScam!**\n\n"
        "Ğ¯ Ğ¿Ğ¾Ğ¼Ğ¾Ğ³Ñƒ Ñ‚ĞµĞ±Ğµ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ğ½Ğ° Ñ‡ĞµÑÑ‚Ğ½Ğ¾ÑÑ‚ÑŒ. Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ:",
        reply_markup=main_menu_keyboard()
    )

@app.on_message(filters.command("mms"))
async def mms_cmd(client, message):
    """ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° Ğ´Ğ»Ñ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ° ÑĞ¿Ğ¸ÑĞºĞ° Ğ³Ğ°Ñ€Ğ°Ğ½Ñ‚Ğ¾Ğ²"""
    admins_data = STAFF_CACHE.get('admins', [])
    
    if not admins_data:
        await message.reply("âš ï¸ **Ğ“Ğ°Ñ€Ğ°Ğ½Ñ‚Ñ‹ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹.** Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¿ÑƒÑÑ‚ Ğ¸Ğ»Ğ¸ Ğ½Ğµ Ğ±Ñ‹Ğ» Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½ Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑĞºĞµ Ğ±Ğ¾Ñ‚Ğ°.")
        return

    text = "ğŸ”¥ **ĞÑ„Ğ¸Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ“Ğ°Ñ€Ğ°Ğ½Ñ‚Ñ‹ SHARK AntiScam:**\n\n"
    buttons = []
    
    for i, info in enumerate(admins_data, 1):
        name = info.get('name', f"ID: {info['id']}")
        username = info.get('username')
        
        text += f"{i}. ğŸ›¡ï¸ **{name}** (@{username or 'ĞĞµÑ‚ ÑĞ·ĞµÑ€Ğ½ĞµĞ¹Ğ¼Ğ°'})\n"
        
        profile_url = f"https://t.me/{username}" if username else f"tg://user?id={info['id']}"
        buttons.append([InlineKeyboardButton(f"ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ {name}", url=profile_url)])
    
    reply_markup = InlineKeyboardMarkup(buttons)
    await message.reply(text, reply_markup=reply_markup)

@app.on_message(filters.regex(r"^[!/]?Ğ¼Ğ¾Ğ´ĞµÑ€Ñ‹$", re.IGNORECASE) & filters.group)
async def moderator_call_cmd(client, message):
    """Ğ’Ñ‹Ğ·Ğ¾Ğ² Ğ¼Ğ¾Ğ´ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ² Ğ² Ñ‡Ğ°Ñ‚Ğµ"""
    caller = message.from_user
    moderator_ids = get_all_moderators()
    
    try:
        chat_link = await get_message_link(client, message)
    except Exception as e:
        logger.error(f"ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑĞ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑÑÑ‹Ğ»ĞºÑƒ Ğ½Ğ° Ñ‡Ğ°Ñ‚: {e}")
        chat_link = f"(ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ÑÑÑ‹Ğ»ĞºÑƒ Ğ½Ğ° Ñ‡Ğ°Ñ‚)"

    if moderator_ids:
        notification_text = (
            f"ğŸš¨ **Ğ’Ğ«Ğ—ĞĞ’ ĞœĞĞ”Ğ•Ğ ĞĞ¢ĞĞ ĞĞ’!**\n\n"
            f"ğŸ‘¤ **Ğ’Ñ‹Ğ·Ğ¾Ğ² Ğ¾Ñ‚:** {caller.first_name} (@{caller.username or 'ID:' + str(caller.id)})\n"
            f"ğŸ“¢ **Ğ§Ğ°Ñ‚:** {message.chat.title}\n"
            f"ğŸ”— **ĞŸĞµÑ€ĞµĞ¹Ñ‚Ğ¸ Ğº ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ:** [ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ¸Ñ‚ÑŒ]({chat_link})"
        )
        
        for mod_id in moderator_ids:
            try:
                await client.send_message(int(mod_id), notification_text, disable_web_page_preview=True)
            except Exception as e:
                logger.warning(f"ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ¸Ñ‚ÑŒ Ğ¼Ğ¾Ğ´ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€Ğ° {mod_id}: {e}")

    await message.reply("âœ… **Ğ¯ Ğ²Ñ‹Ğ·Ğ²Ğ°Ğ» Ğ¼Ğ¾Ğ´ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ²!** ĞĞ½Ğ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ğ»Ğ¸ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ² Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ.")

@app.on_callback_query()
async def handle_callbacks(client, callback_query: CallbackQuery):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº callback-Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²"""
    data = callback_query.data
    user = callback_query.from_user
    
    try:
        if data.startswith("approve_scam_"):
            req_id = data.split("_")[-1]
            request_data = MENTOR_REQUESTS.get(req_id)
            
            if not request_data:
                await callback_query.answer("âŒ Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ ÑƒÑÑ‚Ğ°Ñ€ĞµĞ» Ğ¸Ğ»Ğ¸ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½.", show_alert=True)
                try:
                    await callback_query.message.delete()
                except:
                    pass
                return
            
            target_id = request_data['target_id']
            reason = request_data['reason']
            proof_link = request_data['proof_link']
            rating = request_data['rating']
            volunteer_id = request_data['volunteer_id']
            
            if db_add_scammer_final(target_id, reason, proof_link, rating):
                db_increment_reputation(volunteer_id)
                del MENTOR_REQUESTS[req_id]
                await callback_query.answer("âœ… Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ¾Ğ´Ğ¾Ğ±Ñ€ĞµĞ½!")
                await callback_query.message.edit_text(f"âœ… **Ğ’Ñ‹ Ğ¾Ğ´Ğ¾Ğ±Ñ€Ğ¸Ğ»Ğ¸ Ğ·Ğ°Ğ½ĞµÑĞµĞ½Ğ¸Ğµ!**\nID ÑĞºĞ°Ğ¼ĞµÑ€Ğ°: `{target_id}`")
                
                try:
                    await client.send_message(
                        int(volunteer_id),
                        f"âœ… Ğ’Ğ°Ñˆ ĞºÑƒÑ€Ğ°Ñ‚Ğ¾Ñ€ **Ğ¾Ğ´Ğ¾Ğ±Ñ€Ğ¸Ğ»** Ğ²Ğ°Ñˆ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ½Ğ° Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ `{target_id}` Ğ² Ğ±Ğ°Ğ·Ñƒ!"
                    )
                except:
                    pass
            else:
                await callback_query.answer("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ….", show_alert=True)

        elif data.startswith("reject_scam_"):
            req_id = data.split("_")[-1]
            request_data = MENTOR_REQUESTS.get(req_id)
            if request_data:
                volunteer_id = request_data['volunteer_id']
                del MENTOR_REQUESTS[req_id]
                await callback_query.answer("âŒ Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ¾Ñ‚ĞºĞ»Ğ¾Ğ½ĞµĞ½.")
                await callback_query.message.edit_text("âŒ **Ğ’Ñ‹ Ğ¾Ñ‚ĞºĞ»Ğ¾Ğ½Ğ¸Ğ»Ğ¸ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ.**")
                
                try:
                    await client.send_message(
                        int(volunteer_id),
                        f"âŒ Ğ’Ğ°Ñˆ ĞºÑƒÑ€Ğ°Ñ‚Ğ¾Ñ€ **Ğ¾Ñ‚ĞºĞ»Ğ¾Ğ½Ğ¸Ğ»** Ğ²Ğ°Ñˆ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ½Ğ° Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ² Ğ±Ğ°Ğ·Ñƒ."
                    )
                except:
                    pass
            else:
                await callback_query.answer("Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½.", show_alert=True)

        elif data.startswith("set_scam_rating_"):
            rating = int(data.split("_")[-1])
            if user.id not in PENDING_SCAM_ENTRIES:
                await callback_query.answer("âŒ Ğ¡Ñ€Ğ¾Ğº Ğ¾Ğ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ñ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ Ğ¸ÑÑ‚ĞµĞº.", show_alert=True)
                return
            
            target_id, reason, proof_link = PENDING_SCAM_ENTRIES.pop(user.id)
            
            is_regular_staff = can_moderate(user.id, user.username)
            
            if is_volunteer(user.id) and not is_regular_staff:
                mentor_id = get_mentor_id(user.id)
                if not mentor_id:
                    await callback_query.message.edit_text(
                        "âŒ **ĞÑˆĞ¸Ğ±ĞºĞ°:** Ğ’Ñ‹ Ğ²Ğ¾Ğ»Ğ¾Ğ½Ñ‚ĞµÑ€, Ğ½Ğ¾ Ñƒ Ğ²Ğ°Ñ Ğ½ĞµÑ‚ ĞºÑƒÑ€Ğ°Ñ‚Ğ¾Ñ€Ğ°. "
                        "Ğ’Ñ‹ Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚Ğµ Ğ·Ğ°Ğ½Ğ¾ÑĞ¸Ñ‚ÑŒ Ğ² Ğ±Ğ°Ğ·Ñƒ ÑĞ°Ğ¼Ğ¾ÑÑ‚Ğ¾ÑÑ‚ĞµĞ»ÑŒĞ½Ğ¾."
                    )
                    return
                
                req_id = str(uuid.uuid4())[:8]
                MENTOR_REQUESTS[req_id] = {
                    'target_id': target_id,
                    'reason': reason,
                    'proof_link': proof_link,
                    'rating': rating,
                    'volunteer_id': user.id
                }
                
                kb = InlineKeyboardMarkup([
                    [
                        InlineKeyboardButton("âœ… ĞĞ´Ğ¾Ğ±Ñ€Ğ¸Ñ‚ÑŒ", callback_data=f"approve_scam_{req_id}"),
                        InlineKeyboardButton("âŒ ĞÑ‚ĞºĞ»Ğ¾Ğ½Ğ¸Ñ‚ÑŒ", callback_data=f"reject_scam_{req_id}")
                    ]
                ])
                
                try:
                    await client.send_message(
                        int(mentor_id),
                        f"ğŸ“© **Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ¾Ñ‚ Ğ¿Ğ¾Ğ´Ğ¾Ğ¿ĞµÑ‡Ğ½Ğ¾Ğ³Ğ¾** {user.first_name} (@{user.username})\n\n"
                        f"âš ï¸ Ğ’Ğ°Ñˆ Ğ¿Ğ¾Ğ´Ğ¾Ğ¿ĞµÑ‡Ğ½Ñ‹Ğ¹ Ñ…Ğ¾Ñ‡ĞµÑ‚ **Ğ·Ğ°Ğ½ĞµÑÑ‚Ğ¸ Ğ² Ğ±Ğ°Ğ·Ñƒ** Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ:\n"
                        f"ğŸ‘¤ **Ğ¡ĞºĞ°Ğ¼ĞµÑ€:** `{target_id}`\n"
                        f"ğŸ“ **ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°:** {reason}\n"
                        f"ğŸ“Š **Ğ ĞµĞ¹Ñ‚Ğ¸Ğ½Ğ³:** {SCAM_RATING_OPTIONS[rating]['text']}\n"
                        f"ğŸ”— **ĞŸÑ€ÑƒÑ„Ñ‹:** {proof_link}",
                        reply_markup=kb
                    )
                    await callback_query.message.edit_text("âœ… **Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½ Ğ²Ğ°ÑˆĞµĞ¼Ñƒ ĞºÑƒÑ€Ğ°Ñ‚Ğ¾Ñ€Ñƒ!** ĞĞ¶Ğ¸Ğ´Ğ°Ğ¹Ñ‚Ğµ Ñ€ĞµÑˆĞµĞ½Ğ¸Ñ.")
                except Exception as e:
                    await callback_query.message.edit_text(
                        f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ ĞºÑƒÑ€Ğ°Ñ‚Ğ¾Ñ€Ñƒ: {e}. Ğ’Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾, Ñƒ Ğ½ĞµĞ³Ğ¾ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ° Ğ»Ğ¸Ñ‡ĞºĞ°."
                    )
                return

            if db_add_scammer_final(target_id, reason, proof_link, rating):
                db_increment_reputation(user.id)
                rating_text = SCAM_RATING_OPTIONS[rating]['text']
                await callback_query.message.edit_text(
                    f"âœ… **ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ Ğ² Ğ±Ğ°Ğ·Ñƒ!**\n"
                    f"ID: `{target_id}`\n"
                    f"Ğ ĞµĞ¹Ñ‚Ğ¸Ğ½Ğ³: **{rating_text}**\n"
                    f"ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°: `{reason}`"
                )
            else:
                await callback_query.answer("âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğ¸.", show_alert=True)
            
            await callback_query.answer()
            return
        
        elif data == "my_profile":
            text, _, _ = generate_card_text(user.id, user.username, user.first_name)
            kb = InlineKeyboardMarkup([
                [InlineKeyboardButton("ğŸ³ï¸ Ğ’Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ ÑÑ‚Ñ€Ğ°Ğ½Ñƒ", callback_data="set_country")],
                [InlineKeyboardButton("ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´", callback_data="back_to_menu")]
            ])
            await callback_query.message.edit_text(text, reply_markup=kb)
        
        elif data in ["list_admins", "list_volunteers", "list_employees", "list_coders", 
                      "list_moderators", "list_directors", "list_presidents", "list_designers"]:
            await callback_query.answer("Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°Ñ ÑĞ¿Ğ¸ÑĞ¾Ğº...")
            role_map = {
                "list_presidents": ("presidents", "ĞŸÑ€ĞµĞ·Ğ¸Ğ´ĞµĞ½Ñ‚Ñ‹ ğŸ‘‘", "ğŸ‘‘"),
                "list_admins": ("admins", "Ğ“Ğ°Ñ€Ğ°Ğ½Ñ‚Ñ‹ ğŸ”¥", "ğŸ›¡"),
                "list_employees": ("employees", "Ğ¡Ğ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸ĞºĞ¸ ğŸ’¼", "ğŸ’¼"),
                "list_coders": ("coders", "ĞšĞ¾Ğ´ĞµÑ€Ñ‹ ğŸ’»", "ğŸ’»"),
                "list_moderators": ("moderators", "ĞœĞ¾Ğ´ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€Ñ‹ ğŸ”¨", "ğŸ”¨"),
                "list_directors": ("directors", "Ğ”Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ° ğŸ¯", "ğŸ¯"),
                "list_volunteers": ("volunteers", "Ğ’Ğ¾Ğ»Ğ¾Ğ½Ñ‚Ñ‘Ñ€Ñ‹ ğŸŒ´", "ğŸ©"),
                "list_designers": ("designers", "Ğ”Ğ¸Ğ·Ğ°Ğ¹Ğ½ĞµÑ€Ñ‹ ğŸ¨", "ğŸ¨"),
            }
            role_table, role_name, role_emoji = role_map.get(data)
            staff_list_text = f"âœ¨ **Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº {role_name}:**\n\n"
            staff_data = STAFF_CACHE.get(role_table, [])
            
            for i, info in enumerate(staff_data, 1):
                name = info.get('name', f"ID: {info['id']}")
                username = info.get('username')
                if username:
                    staff_list_text += f"{i}. {role_emoji} **{name}** (@{username})\n"
                else:
                    staff_list_text += f"{i}. {role_emoji} **{name}** (ĞšĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚ ÑĞºÑ€Ñ‹Ñ‚)\n"
            
            if not staff_data:
                staff_list_text += "Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¿ÑƒÑÑ‚."
            
            await callback_query.message.edit_text(staff_list_text, reply_markup=back_to_menu_keyboard())
        
        elif data == "report_scam":
            await callback_query.message.edit_text(
                "ğŸ˜¡ **ĞšĞ°Ğº ÑĞ»Ğ¸Ñ‚ÑŒ ÑĞºĞ°Ğ¼Ğ¼ĞµÑ€Ğ°?**\n\n"
                "Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñƒ: `/scam @username ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ° Ğ¡ÑÑ‹Ğ»ĞºĞ°ĞĞ°ĞŸÑ€ÑƒÑ„Ñ‹`.\n"
                "Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ ĞŸĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»Ñƒ SHARK.",
                reply_markup=back_to_menu_keyboard()
            )
        
        elif data == "faq":
            text = (
                "â“ **Ğ§Ğ°ÑÑ‚Ñ‹Ğµ Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹ (FAQ)**\n\n"
                "**ĞšĞ°Ğº Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ?** ĞĞ°Ğ¿Ğ¸ÑˆĞ¸ `Ğ§ĞµĞº @username`.\n"
                "**ĞšĞ°Ğº ÑÑ‚Ğ°Ñ‚ÑŒ Ğ“Ğ°Ñ€Ğ°Ğ½Ñ‚Ğ¾Ğ¼?** Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ Ğ²Ñ‹Ğ´Ğ°ĞµÑ‚ Ğ’Ğ»Ğ°Ğ´ĞµĞ»ĞµÑ†/ĞŸÑ€ĞµĞ·Ğ¸Ğ´ĞµĞ½Ñ‚.\n"
                "**ĞšĞ°Ğº Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ÑĞºĞ°Ğ¼Ğ¼ĞµÑ€Ğ°?** ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° `/scam` Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ° Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»Ñƒ.\n"
                "**ĞšĞ°Ğº ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ ÑÑ‚Ñ€Ğ°Ğ½Ñƒ?** Ğ’ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ğµ Ğ½Ğ°Ğ¶Ğ¼Ğ¸ 'Ğ’Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ ÑÑ‚Ñ€Ğ°Ğ½Ñƒ'."
            )
            await callback_query.message.edit_text(text, reply_markup=back_to_menu_keyboard())
        
        elif data == "stats":
            total_scammers = cursor.execute("SELECT COUNT(user_id) FROM scammers").fetchone()[0]
            total_presidents = cursor.execute("SELECT COUNT(user_id) FROM presidents").fetchone()[0]
            total_directors = cursor.execute("SELECT COUNT(user_id) FROM directors").fetchone()[0]
            total_admins = cursor.execute("SELECT COUNT(user_id) FROM admins").fetchone()[0]
            total_volunteers = cursor.execute("SELECT COUNT(user_id) FROM volunteers").fetchone()[0]
            total_coders = cursor.execute("SELECT COUNT(user_id) FROM coders").fetchone()[0]
            total_employees = cursor.execute("SELECT COUNT(user_id) FROM employees").fetchone()[0]
            total_moderators = cursor.execute("SELECT COUNT(user_id) FROM moderators").fetchone()[0]
            total_designers = cursor.execute("SELECT COUNT(user_id) FROM designers").fetchone()[0]
            total_rep = cursor.execute("SELECT IFNULL(SUM(count), 0) FROM reputation").fetchone()[0]
            
            text = (
                f"ğŸ“Š **Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° SHARK AntiScam**\n\n"
                f"â›” Ğ¡ĞºĞ°Ğ¼ĞµÑ€Ğ¾Ğ² Ğ² Ğ±Ğ°Ğ·Ğµ: **{total_scammers}**\n"
                f"ğŸ‘‘ ĞŸÑ€ĞµĞ·Ğ¸Ğ´ĞµĞ½Ñ‚Ğ¾Ğ²: **{total_presidents}**\n"
                f"ğŸ¯ Ğ”Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¾Ğ²: **{total_directors}**\n"
                f"ğŸ›¡ Ğ“Ğ°Ñ€Ğ°Ğ½Ñ‚Ğ¾Ğ²: **{total_admins}**\n"
                f"ğŸ’» ĞšĞ¾Ğ´ĞµÑ€Ğ¾Ğ²: **{total_coders}**\n"
                f"ğŸ¨ Ğ”Ğ¸Ğ·Ğ°Ğ¹Ğ½ĞµÑ€Ğ¾Ğ²: **{total_designers}**\n"
                f"ğŸ’¼ Ğ¡Ğ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸ĞºĞ¾Ğ²: **{total_employees}**\n"
                f"ğŸ”¨ ĞœĞ¾Ğ´ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ²: **{total_moderators}**\n"
                f"ğŸ© Ğ’Ğ¾Ğ»Ğ¾Ğ½Ñ‚ĞµÑ€Ğ¾Ğ² (Ğ¡Ñ‚Ğ°Ğ¶ĞµÑ€Ğ¾Ğ²): **{total_volunteers}**\n"
                f"ğŸ¤ ĞĞ±Ñ‰Ğ°Ñ Ñ€ĞµĞ¿ÑƒÑ‚Ğ°Ñ†Ğ¸Ñ (ÑĞ»Ğ¸Ñ‚Ğ¾): **{total_rep}**\n"
            )
            await callback_query.message.edit_text(text, reply_markup=back_to_menu_keyboard())

        elif data == "premium":
            await callback_query.message.edit_text(
                "ğŸŒ¸ **ĞŸÑ€ĞµĞ¼Ğ¸ÑƒĞ¼-Ğ´Ğ¾ÑÑ‚ÑƒĞ¿**\n\n"
                "Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ½Ğ°Ñ…Ğ¾Ğ´Ğ¸Ñ‚ÑÑ Ğ² Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞµ. Ğ¡ĞºĞ¾Ñ€Ğ¾ Ğ¿Ğ¾ÑĞ²Ğ¸Ñ‚ÑÑ!",
                reply_markup=back_to_menu_keyboard()
            )
        
        elif data == "back_to_menu":
            await callback_query.message.edit_text(
                "ğŸ‘‹ **Ğ“Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ**\nĞ’Ñ‹Ğ±ĞµÑ€Ğ¸ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ:",
                reply_markup=main_menu_keyboard()
            )
        
        elif data == "set_country":
            await callback_query.answer()
            await callback_query.message.edit_text(
                "ğŸŒ **Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ²Ğ°ÑˆÑƒ ÑÑ‚Ñ€Ğ°Ğ½Ñƒ Ğ¸Ğ· ÑĞ¿Ğ¸ÑĞºĞ°:**",
                reply_markup=select_country_keyboard()
            )
        
        elif data.startswith("country_"):
            selected_country = data.split("_", 1)[1]
            db_set_country(user.id, selected_country)
            text, _, _ = generate_card_text(user.id, user.username, user.first_name)
            kb = InlineKeyboardMarkup([
                [InlineKeyboardButton("ğŸ³ï¸ Ğ’Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ ÑÑ‚Ñ€Ğ°Ğ½Ñƒ", callback_data="set_country")],
                [InlineKeyboardButton("ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´", callback_data="back_to_menu")]
            ])
            await callback_query.answer(f"âœ… Ğ¡Ñ‚Ñ€Ğ°Ğ½Ğ° ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ°: {selected_country}")
            await callback_query.message.edit_text(text, reply_markup=kb)
        
    except Exception as e:
        logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ² Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞµ callback: {e}")
        try:
            await callback_query.answer("ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ°. ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ¿Ğ¾Ğ·Ğ¶Ğµ.")
        except:
            pass

# ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»Ğ¾Ğ¼
@app.on_message(filters.command("ĞºÑƒÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ"))
async def curate_cmd(client, message):
    """ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ ĞºÑƒÑ€Ğ°Ñ‚Ğ¾Ñ€Ğ° Ğ´Ğ»Ñ Ğ²Ğ¾Ğ»Ğ¾Ğ½Ñ‚ĞµÑ€Ğ°"""
    try:
        sender_id = message.from_user.id
        
        if not (is_president(sender_id) or is_director(sender_id) or is_owner(sender_id, message.from_user.username)):
            await message.reply("âŒ ĞšÑƒÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¼Ğ¾Ğ³ÑƒÑ‚ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ĞŸÑ€ĞµĞ·Ğ¸Ğ´ĞµĞ½Ñ‚Ñ‹, Ğ”Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ° Ğ¸ Ğ’Ğ»Ğ°Ğ´ĞµĞ»ÑŒÑ†Ñ‹.")
            return

        parts = message.text.split(maxsplit=1)
        args = parts[1] if len(parts) > 1 else None
        target, _ = await find_target(client, message, args)
        
        if not target or not str(target.id).isdigit():
            await message.reply("âš ï¸ ĞŸÑ€Ğ¸Ğ¼ĞµÑ€: `/ĞºÑƒÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ @username`")
            return
        
        if not is_volunteer(target.id):
            await message.reply("âŒ ĞšÑƒÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ¢ĞĞ›Ğ¬ĞšĞ Ğ²Ğ¾Ğ»Ğ¾Ğ½Ñ‚ĞµÑ€Ğ¾Ğ².")
            return

        set_mentor(target.id, sender_id)
        await message.reply(f"ğŸ“ Ğ’Ñ‹ Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ñ‹ ĞºÑƒÑ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ¼ Ğ´Ğ»Ñ **{target.first_name}**!")
        try:
            await client.send_message(target.id, f"ğŸ“ **{message.from_user.first_name}** Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½ Ğ²Ğ°ÑˆĞ¸Ğ¼ ĞºÑƒÑ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ¼!")
        except:
            pass
    except Exception as e:
        logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ² ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğµ ĞºÑƒÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ: {e}")
        await message.reply("âŒ ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğ¸ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹.")

@app.on_message(filters.command("Ğ²Ñ‹Ğ³Ğ¾Ğ²Ğ¾Ñ€"))
async def reprimand_cmd(client, message):
    """Ğ’Ñ‹Ğ´Ğ°Ñ‡Ğ° Ğ²Ñ‹Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ° Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»Ñƒ"""
    try:
        sender_id = message.from_user.id
        sender_username = message.from_user.username
        parts = message.text.split(maxsplit=1)
        args = parts[1] if len(parts) > 1 else None
        target, _ = await find_target(client, message, args)

        if not target or not str(target.id).isdigit():
            await message.reply("âš ï¸ ĞŸÑ€Ğ¸Ğ¼ĞµÑ€: `/Ğ²Ñ‹Ğ³Ğ¾Ğ²Ğ¾Ñ€ @username` Ğ¸Ğ»Ğ¸ Ğ¾Ñ‚Ğ²ĞµÑ‚ÑŒÑ‚Ğµ Ğ½Ğ° ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ.")
            return
        
        t_id = target.id
        if t_id == sender_id:
            await message.reply("âŒ ĞĞµĞ»ÑŒĞ·Ñ Ğ²Ñ‹Ğ´Ğ°Ñ‚ÑŒ Ğ²Ñ‹Ğ³Ğ¾Ğ²Ğ¾Ñ€ ÑĞ°Ğ¼Ğ¾Ğ¼Ñƒ ÑĞµĞ±Ğµ.")
            return
        if not is_any_staff(t_id, target.username):
            await message.reply("âŒ Ğ’Ñ‹Ğ³Ğ¾Ğ²Ğ¾Ñ€Ñ‹ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ²Ñ‹Ğ´Ğ°Ğ²Ğ°Ñ‚ÑŒ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»Ñƒ.")
            return

        can_reprimand = False
        
        if is_owner(sender_id, sender_username) or is_coder(sender_id):
            can_reprimand = True
        elif is_president(sender_id):
            if is_director(t_id) or is_employee(t_id) or is_volunteer(t_id) or is_moderator(t_id):
                can_reprimand = True
            else:
                await message.reply("âŒ ĞŸÑ€ĞµĞ·Ğ¸Ğ´ĞµĞ½Ñ‚ Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ²Ñ‹Ğ´Ğ°Ğ²Ğ°Ñ‚ÑŒ Ğ²Ñ‹Ğ³Ğ¾Ğ²Ğ¾Ñ€ Ğ²Ñ‹ÑˆĞµÑÑ‚Ğ¾ÑÑ‰Ğ¸Ğ¼ Ğ¸Ğ»Ğ¸ Ñ€Ğ°Ğ²Ğ½Ñ‹Ğ¼.")
                return
        elif is_director(sender_id):
            if is_employee(t_id) or is_volunteer(t_id) or is_moderator(t_id):
                can_reprimand = True
            else:
                await message.reply("âŒ Ğ”Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ½Ğ°ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¡Ğ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸ĞºĞ¾Ğ², Ğ’Ğ¾Ğ»Ğ¾Ğ½Ñ‚ĞµÑ€Ğ¾Ğ² Ğ¸ ĞœĞ¾Ğ´ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ².")
                return
        else:
            await message.reply("âŒ Ğ£ Ğ²Ğ°Ñ Ğ½ĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ¿Ñ€Ğ°Ğ² Ğ´Ğ»Ñ Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğ¸ Ğ²Ñ‹Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ¾Ğ².")
            return

        if can_reprimand:
            new_count = add_reprimand(t_id)
            
            if new_count >= 3:
                remove_all_staff_roles(t_id)
                clear_reprimands(t_id)
                await fetch_staff_info()
                await message.reply(
                    f"ğŸš« **Ğ£Ğ’ĞĞ›Ğ¬ĞĞ•ĞĞ˜Ğ•!**\n\n"
                    f"ğŸ‘¤ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ: **{target.first_name}**\n"
                    f"â—ï¸ Ğ”Ğ¾ÑÑ‚Ğ¸Ğ³Ğ½ÑƒÑ‚ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚ Ğ²Ñ‹Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ¾Ğ² (3/3).\n"
                    f"âŒ Ğ’ÑĞµ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ¾ÑÑ‚Ğ¸ ÑĞ½ÑÑ‚Ñ‹ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸."
                )
            else:
                await message.reply(
                    f"âš ï¸ **Ğ’Ñ‹Ğ´Ğ°Ğ½ Ğ²Ñ‹Ğ³Ğ¾Ğ²Ğ¾Ñ€!**\n\n"
                    f"ğŸ‘¤ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ: **{target.first_name}**\n"
                    f"ğŸ”¢ Ğ’ÑĞµĞ³Ğ¾ Ğ²Ñ‹Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ¾Ğ²: **{new_count}/3**\n"
                    f"ĞŸÑ€Ğ¸ Ğ´Ğ¾ÑÑ‚Ğ¸Ğ¶ĞµĞ½Ğ¸Ğ¸ 3-Ñ… Ğ²Ñ‹Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ¾Ğ² Ñ€Ğ¾Ğ»ÑŒ Ğ±ÑƒĞ´ĞµÑ‚ ÑĞ½ÑÑ‚Ğ°."
                )
    except Exception as e:
        logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ² ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğµ Ğ²Ñ‹Ğ³Ğ¾Ğ²Ğ¾Ñ€: {e}")
        await message.reply("âŒ ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğ¸ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹.")

@app.on_message(filters.command("Ğ¼ÑƒÑ‚") & filters.group)
async def mute_cmd(client, message):
    """ĞœÑƒÑ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ² Ğ³Ñ€ÑƒĞ¿Ğ¿Ğµ"""
    try:
        if not can_temp_moderate(message.from_user.id, message.from_user.username):
            await message.reply("ğŸ›¡ Ğ£ Ğ²Ğ°Ñ Ğ½ĞµÑ‚ Ğ¿Ñ€Ğ°Ğ².")
            return
        
        target_user = None
        time_str = None
        reason = "Ğ‘ĞµĞ· Ğ¿Ñ€Ğ¸Ñ‡Ğ¸Ğ½Ñ‹"
        
        if message.reply_to_message:
            target_user = message.reply_to_message.from_user
            args = message.text.split(maxsplit=1)[1] if len(message.text.split(maxsplit=1)) > 1 else ""
            parts = args.split(maxsplit=1)
            time_str = parts[0] if parts else None
            reason = parts[1] if len(parts) > 1 else reason
        elif len(message.command) >= 3:
            target_str = message.command[1]
            time_str = message.command[2]
            reason = " ".join(message.command[3:]) if len(message.command) > 3 else reason
            try:
                target_user, _ = await find_target(client, message, target_str)
            except:
                pass
        
        if not target_user:
            await message.reply("âš ï¸ ĞŸÑ€Ğ¸Ğ¼ĞµÑ€: `/Ğ¼ÑƒÑ‚ @username 30m` Ğ¸Ğ»Ğ¸ Ğ¾Ñ‚Ğ²ĞµÑ‚ÑŒÑ‚Ğµ Ğ½Ğ° ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ.")
            return
        
        if time_str:
            until_date, error = parse_time(time_str)
            if error:
                return await message.reply(f"âŒ {error}")
        else:
            until_date = datetime.now() + timedelta(days=366)

        try:
            await client.restrict_chat_member(
                message.chat.id, 
                target_user.id, 
                ChatPermissions(), 
                until_date=until_date
            )
            await message.reply(f"ğŸ”¨ ĞœÑƒÑ‚ **{target_user.first_name}** Ğ½Ğ° {time_str or 'Ğ½Ğ°Ğ²ÑĞµĞ³Ğ´Ğ°'}. ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°: {reason}")
        except ChatAdminRequired:
            await message.reply("âŒ Ğ£ Ğ¼ĞµĞ½Ñ Ğ½ĞµÑ‚ Ğ¿Ñ€Ğ°Ğ² Ğ´Ğ»Ñ Ğ¼ÑƒÑ‚Ğ° Ğ² ÑÑ‚Ğ¾Ğ¼ Ñ‡Ğ°Ñ‚Ğµ.")
        except Exception as e:
            await message.reply(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: {e}")
    except Exception as e:
        logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ² ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğµ Ğ¼ÑƒÑ‚: {e}")
        await message.reply("âŒ ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğ¸ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹.")

# ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸
@app.on_message(filters.regex(r"(?i)^(Ñ‡ĞµĞº|check|/check)\b"))
async def check_handler(client, message):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸"""
    try:
        user_id = message.from_user.id
        username = message.from_user.username
        current_time = datetime.now()
        is_staff_member = can_moderate(user_id, username)

        if not is_staff_member:
            if user_id in RATE_LIMITS:
                if (current_time - RATE_LIMITS[user_id]).total_seconds() < CHECK_LIMIT_SECONDS:
                    await message.reply("â° ĞŸĞ¾Ğ´Ğ¾Ğ¶Ğ´Ğ¸Ñ‚Ğµ Ğ¿ĞµÑ€ĞµĞ´ ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğ¼ Ñ‡ĞµĞºĞ¾Ğ¼.")
                    return
            RATE_LIMITS[user_id] = current_time
        
        parts = message.text.split(maxsplit=1)
        args = parts[1] if len(parts) > 1 else None
        target, not_found = await find_target(client, message, args)
        
        if not target:
            if not_found:
                await message.reply(f"âŒ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ `{not_found}` Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½.")
            else:
                await message.reply("âš ï¸ ĞŸÑ€Ğ¸Ğ¼ĞµÑ€: `Ğ§ĞµĞº @username` Ğ¸Ğ»Ğ¸ Ğ¾Ñ‚Ğ²ĞµÑ‚ÑŒÑ‚Ğµ Ğ½Ğ° ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ.")
            return
        
        guarantor_link = None
        if cursor.execute("SELECT 1 FROM trusted WHERE user_id = ?", (str(target.id),)).fetchone():
            guarantor_link = await get_guarantor_link(client, target.id)

        mentor_link = None
        if is_volunteer(target.id):
            mentor_link = await get_mentor_link(client, target.id)

        text, is_owner_flag, _ = generate_card_text(
            target.id, target.username, target.first_name, 
            guarantor_link, mentor_link
        )
        profile_kb = get_profile_keyboard(target.id, target.username)
        
        if is_owner_flag:
            try:
                await client.send_photo(
                    message.chat.id, 
                    OWNER_PHOTO_PATH, 
                    caption=text, 
                    reply_markup=profile_kb
                )
            except:
                await message.reply(text, reply_markup=profile_kb)
        else:
            await message.reply(text, reply_markup=profile_kb)
    except Exception as e:
        logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ² ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğµ Ñ‡ĞµĞº: {e}")
        await message.reply("âŒ ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ.")

# ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ/ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ Ñ€Ğ¾Ğ»ĞµĞ¹
@app.on_message(filters.regex(r"(?i)^\+Ğ¿Ñ€ĞµĞ·Ğ¸Ğ´ĞµĞ½Ñ‚"))
async def add_president(client, message):
    try:
        if not is_owner(message.from_user.id, message.from_user.username): 
            return
        parts = message.text.split(maxsplit=1)
        args = parts[1] if len(parts) > 1 else None
        target, _ = await find_target(client, message, args)
        if target and str(target.id).isdigit():
            remove_all_staff_roles(target.id)
            cursor.execute("INSERT OR REPLACE INTO presidents (user_id) VALUES (?)", (str(target.id),))
            conn.commit()
            await fetch_staff_info()
            await message.reply(f"ğŸ‘‘ **{target.first_name}** Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½ ĞŸÑ€ĞµĞ·Ğ¸Ğ´ĞµĞ½Ñ‚Ğ¾Ğ¼!")
    except Exception as e:
        logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ² ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğµ +Ğ¿Ñ€ĞµĞ·Ğ¸Ğ´ĞµĞ½Ñ‚: {e}")

@app.on_message(filters.regex(r"(?i)^\-Ğ¿Ñ€ĞµĞ·Ğ¸Ğ´ĞµĞ½Ñ‚"))
async def remove_president(client, message):
    try:
        if not is_owner(message.from_user.id, message.from_user.username): 
            return
        parts = message.text.split(maxsplit=1)
        args = parts[1] if len(parts) > 1 else None
        target, _ = await find_target(client, message, args)
        if target and str(target.id).isdigit():
            if cursor.execute("DELETE FROM presidents WHERE user_id = ?", (str(target.id),)).rowcount > 0:
                conn.commit()
                await fetch_staff_info()
                await message.reply(f"ğŸ‘‘ **{target.first_name}** ÑĞ½ÑÑ‚ Ñ Ğ¿Ğ¾ÑÑ‚Ğ° ĞŸÑ€ĞµĞ·Ğ¸Ğ´ĞµĞ½Ñ‚Ğ°.")
            else: 
                await message.reply("â„¹ï¸ ĞĞµ Ğ±Ñ‹Ğ» ĞŸÑ€ĞµĞ·Ğ¸Ğ´ĞµĞ½Ñ‚Ğ¾Ğ¼.")
    except Exception as e:
        logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ² ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğµ -Ğ¿Ñ€ĞµĞ·Ğ¸Ğ´ĞµĞ½Ñ‚: {e}")

@app.on_message(filters.regex(r"(?i)^\+Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€"))
async def add_director(client, message):
    try:
        if not (is_owner(message.from_user.id, message.from_user.username) or is_president(message.from_user.id)): 
            return
        parts = message.text.split(maxsplit=1)
        args = parts[1] if len(parts) > 1 else None
        target, _ = await find_target(client, message, args)
        if target:
            remove_all_staff_roles(target.id)
            cursor.execute("INSERT OR REPLACE INTO directors (user_id) VALUES (?)", (str(target.id),))
            conn.commit()
            await fetch_staff_info()
            await message.reply(f"ğŸ¯ **{target.first_name}** Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½ Ğ”Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¾Ğ¼!")
    except Exception as e:
        logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ² ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğµ +Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€: {e}")

@app.on_message(filters.regex(r"(?i)^\-Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€"))
async def remove_director(client, message):
    try:
        if not (is_owner(message.from_user.id, message.from_user.username) or is_president(message.from_user.id)): 
            return
        parts = message.text.split(maxsplit=1)
        args = parts[1] if len(parts) > 1 else None
        target, _ = await find_target(client, message, args)
        if target:
            cursor.execute("DELETE FROM directors WHERE user_id = ?", (str(target.id),))
            conn.commit()
            await fetch_staff_info()
            await message.reply(f"ğŸ¯ **{target.first_name}** ÑĞ½ÑÑ‚ Ñ Ğ”Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ°.")
    except Exception as e:
        logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ² ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğµ -Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€: {e}")

@app.on_message(filters.regex(r"(?i)^\+ĞºĞ¾Ğ´ĞµÑ€"))
async def add_coder(client, message):
    try:
        if not is_full_staff(message.from_user.id, message.from_user.username): 
            return
        parts = message.text.split(maxsplit=1)
        args = parts[1] if len(parts) > 1 else None
        target, _ = await find_target(client, message, args)
        if target:
            remove_all_staff_roles(target.id)
            cursor.execute("INSERT OR REPLACE INTO coders (user_id) VALUES (?)", (str(target.id),))
            conn.commit()
            await fetch_staff_info()
            await message.reply(f"ğŸ’» **{target.first_name}** Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½ ĞšĞ¾Ğ´ĞµÑ€Ğ¾Ğ¼!")
    except Exception as e:
        logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ² ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğµ +ĞºĞ¾Ğ´ĞµÑ€: {e}")

@app.on_message(filters.regex(r"(?i)^\-ĞºĞ¾Ğ´ĞµÑ€"))
async def remove_coder(client, message):
    try:
        if not is_full_staff(message.from_user.id, message.from_user.username): 
            return
        parts = message.text.split(maxsplit=1)
        args = parts[1] if len(parts) > 1 else None
        target, _ = await find_target(client, message, args)
        if target:
            cursor.execute("DELETE FROM coders WHERE user_id = ?", (str(target.id),))
            conn.commit()
            await fetch_staff_info()
            await message.reply(f"ğŸ’» **{target.first_name}** ÑĞ½ÑÑ‚ Ñ ĞšĞ¾Ğ´ĞµÑ€Ğ°.")
    except Exception as e:
        logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ² ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğµ -ĞºĞ¾Ğ´ĞµÑ€: {e}")

@app.on_message(filters.regex(r"(?i)^\+Ğ´Ğ¸Ğ·Ğ°Ğ¹Ğ½ĞµÑ€"))
async def add_designer(client, message):
    try:
        if not is_full_staff(message.from_user.id, message.from_user.username): 
            return
        parts = message.text.split(maxsplit=1)
        args = parts[1] if len(parts) > 1 else None
        target, _ = await find_target(client, message, args)
        if target:
            remove_all_staff_roles(target.id)
            cursor.execute("INSERT OR REPLACE INTO designers (user_id) VALUES (?)", (str(target.id),))
            conn.commit()
            await fetch_staff_info()
            await message.reply(f"ğŸ¨ **{target.first_name}** Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½ Ğ”Ğ¸Ğ·Ğ°Ğ¹Ğ½ĞµÑ€Ğ¾Ğ¼!")
    except Exception as e:
        logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ² ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğµ +Ğ´Ğ¸Ğ·Ğ°Ğ¹Ğ½ĞµÑ€: {e}")

@app.on_message(filters.regex(r"(?i)^\-Ğ´Ğ¸Ğ·Ğ°Ğ¹Ğ½ĞµÑ€"))
async def remove_designer(client, message):
    try:
        if not is_full_staff(message.from_user.id, message.from_user.username): 
            return
        parts = message.text.split(maxsplit=1)
        args = parts[1] if len(parts) > 1 else None
        target, _ = await find_target(client, message, args)
        if target:
            cursor.execute("DELETE FROM designers WHERE user_id = ?", (str(target.id),))
            conn.commit()
            await fetch_staff_info()
            await message.reply(f"ğŸ¨ **{target.first_name}** ÑĞ½ÑÑ‚ Ñ Ğ”Ğ¸Ğ·Ğ°Ğ¹Ğ½ĞµÑ€Ğ°.")
    except Exception as e:
        logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ² ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğµ -Ğ´Ğ¸Ğ·Ğ°Ğ¹Ğ½ĞµÑ€: {e}")

@app.on_message(filters.regex(r"(?i)^\+Ğ³Ğ°Ñ€Ğ°Ğ½Ñ‚"))
async def add_guarantor(client, message):
    try:
        if not (is_owner(message.from_user.id, message.from_user.username) or is_president(message.from_user.id)): 
            return
        parts = message.text.split(maxsplit=1)
        args = parts[1] if len(parts) > 1 else None
        target, _ = await find_target(client, message, args)
        if target:
            remove_all_staff_roles(target.id)
            cursor.execute("INSERT OR REPLACE INTO admins (user_id) VALUES (?)", (str(target.id),))
            conn.commit()
            await fetch_staff_info()
            await message.reply(f"ğŸ›¡ **{target.first_name}** Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½ Ğ“Ğ°Ñ€Ğ°Ğ½Ñ‚Ğ¾Ğ¼!")
    except Exception as e:
        logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ² ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğµ +Ğ³Ğ°Ñ€Ğ°Ğ½Ñ‚: {e}")

@app.on_message(filters.regex(r"(?i)^\-Ğ³Ğ°Ñ€Ğ°Ğ½Ñ‚"))
async def remove_guarantor(client, message):
    try:
        if not (is_owner(message.from_user.id, message.from_user.username) or is_president(message.from_user.id)): 
            return
        parts = message.text.split(maxsplit=1)
        args = parts[1] if len(parts) > 1 else None
        target, _ = await find_target(client, message, args)
        if target:
            cursor.execute("DELETE FROM admins WHERE user_id = ?", (str(target.id),))
            conn.commit()
            await fetch_staff_info()
            await message.reply(f"ğŸ›¡ **{target.first_name}** ÑĞ½ÑÑ‚ Ñ Ğ“Ğ°Ñ€Ğ°Ğ½Ñ‚Ğ°.")
    except Exception as e:
        logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ² ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğµ -Ğ³Ğ°Ñ€Ğ°Ğ½Ñ‚: {e}")

@app.on_message(filters.regex(r"(?i)^\+ÑĞ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸Ğº"))
async def add_employee(client, message):
    try:
        if not can_moderate(message.from_user.id, message.from_user.username): 
            return
        parts = message.text.split(maxsplit=1)
        args = parts[1] if len(parts) > 1 else None
        target, _ = await find_target(client, message, args)
        if target:
            remove_all_staff_roles(target.id)
            cursor.execute("INSERT OR REPLACE INTO employees (user_id) VALUES (?)", (str(target.id),))
            conn.commit()
            await fetch_staff_info()
            await message.reply(f"ğŸ’¼ **{target.first_name}** Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½ Ğ¡Ğ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸ĞºĞ¾Ğ¼!")
    except Exception as e:
        logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ² ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğµ +ÑĞ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸Ğº: {e}")

@app.on_message(filters.regex(r"(?i)^\-ÑĞ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸Ğº"))
async def remove_employee(client, message):
    try:
        if not can_moderate(message.from_user.id, message.from_user.username): 
            return
        parts = message.text.split(maxsplit=1)
        args = parts[1] if len(parts) > 1 else None
        target, _ = await find_target(client, message, args)
        if target:
            cursor.execute("DELETE FROM employees WHERE user_id = ?", (str(target.id),))
            conn.commit()
            await fetch_staff_info()
            await message.reply(f"ğŸ’¼ **{target.first_name}** ÑĞ½ÑÑ‚ Ñ Ğ¡Ğ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸ĞºĞ°.")
    except Exception as e:
        logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ² ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğµ -ÑĞ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸Ğº: {e}")

@app.on_message(filters.regex(r"(?i)^\+Ğ¼Ğ¾Ğ´ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€"))
async def add_moderator(client, message):
    try:
        if not is_full_staff(message.from_user.id, message.from_user.username): 
            return
        parts = message.text.split(maxsplit=1)
        args = parts[1] if len(parts) > 1 else None
        target, _ = await find_target(client, message, args)
        if target:
            remove_all_staff_roles(target.id)
            cursor.execute("INSERT OR REPLACE INTO moderators (user_id) VALUES (?)", (str(target.id),))
            conn.commit()
            await fetch_staff_info()
            await message.reply(f"ğŸ”¨ **{target.first_name}** Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½ ĞœĞ¾Ğ´ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ¼!")
    except Exception as e:
        logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ² ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğµ +Ğ¼Ğ¾Ğ´ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€: {e}")

@app.on_message(filters.regex(r"(?i)^\-Ğ¼Ğ¾Ğ´ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€"))
async def remove_moderator(client, message):
    try:
        if not is_full_staff(message.from_user.id, message.from_user.username): 
            return
        parts = message.text.split(maxsplit=1)
        args = parts[1] if len(parts) > 1 else None
        target, _ = await find_target(client, message, args)
        if target:
            cursor.execute("DELETE FROM moderators WHERE user_id = ?", (str(target.id),))
            conn.commit()
            await fetch_staff_info()
            await message.reply(f"ğŸ”¨ **{target.first_name}** ÑĞ½ÑÑ‚ Ñ ĞœĞ¾Ğ´ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€Ğ°.")
    except Exception as e:
        logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ² ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğµ -Ğ¼Ğ¾Ğ´ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€: {e}")

@app.on_message(filters.regex(r"(?i)^(\+Ğ²Ğ¾Ğ»Ğ¾Ğ½Ñ‚ĞµÑ€|\+ÑÑ‚Ğ°Ğ¶ĞµÑ€|\/volunteer)"))
async def add_volunteer(client, message):
    try:
        if not can_moderate(message.from_user.id, message.from_user.username): 
            return
        parts = message.text.split(maxsplit=1)
        args = parts[1] if len(parts) > 1 else None
        target, _ = await find_target(client, message, args)
        if target:
            remove_all_staff_roles(target.id)
            cursor.execute("INSERT OR REPLACE INTO volunteers (user_id) VALUES (?)", (str(target.id),))
            conn.commit()
            await fetch_staff_info()
            await message.reply(f"ğŸ© **{target.first_name}** Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½ Ğ’Ğ¾Ğ»Ğ¾Ğ½Ñ‚ĞµÑ€Ğ¾Ğ¼!")
    except Exception as e:
        logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ² ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğµ +Ğ²Ğ¾Ğ»Ğ¾Ğ½Ñ‚ĞµÑ€: {e}")

@app.on_message(filters.regex(r"(?i)^(\-Ğ²Ğ¾Ğ»Ğ¾Ğ½Ñ‚ĞµÑ€|\-ÑÑ‚Ğ°Ğ¶ĞµÑ€)"))
async def remove_volunteer(client, message):
    try:
        if not can_moderate(message.from_user.id, message.from_user.username): 
            return
        parts = message.text.split(maxsplit=1)
        args = parts[1] if len(parts) > 1 else None
        target, _ = await find_target(client, message, args)
        if target:
            cursor.execute("DELETE FROM volunteers WHERE user_id = ?", (str(target.id),))
            conn.commit()
            await fetch_staff_info()
            await message.reply(f"ğŸ© **{target.first_name}** ÑĞ½ÑÑ‚ Ñ Ğ¿Ğ¾ÑÑ‚Ğ°.")
    except Exception as e:
        logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ² ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğµ -Ğ²Ğ¾Ğ»Ğ¾Ğ½Ñ‚ĞµÑ€: {e}")

# ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ Ğ´Ğ¾Ğ²ĞµÑ€Ğ¸Ñ Ğ¸ Ñ€ĞµĞ¿ÑƒÑ‚Ğ°Ñ†Ğ¸Ğ¸
@app.on_message(filters.command("trust") | filters.regex(r"(?i)^/Ñ‚Ñ€Ğ°ÑÑ‚"))
async def add_trust(client, message):
    try:
        if not is_full_staff(message.from_user.id, message.from_user.username): 
            return
        parts = message.text.split(maxsplit=1)
        args = parts[1] if len(parts) > 1 else None
        target, _ = await find_target(client, message, args)
        
        sender_id = str(message.from_user.id)
        
        if target and str(target.id).isdigit():
            cursor.execute("INSERT OR REPLACE INTO trusted (user_id, guarantor_id) VALUES (?, ?)", 
                           (str(target.id), sender_id))
            conn.commit()
            await message.reply(f"ğŸ’  **{target.first_name}** Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ğ» ÑÑ‚Ğ°Ñ‚ÑƒÑ 'ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞµĞ½ Ğ³Ğ°Ñ€Ğ°Ğ½Ñ‚Ğ¾Ğ¼'!")
    except Exception as e:
        logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ² ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğµ trust: {e}")

@app.on_message(filters.regex(r"(?i)^\-Ñ‚Ñ€Ğ°ÑÑ‚"))
async def remove_trust(client, message):
    try:
        if not is_full_staff(message.from_user.id, message.from_user.username): 
            return
        parts = message.text.split(maxsplit=1)
        args = parts[1] if len(parts) > 1 else None
        target, _ = await find_target(client, message, args)
        if target:
            if cursor.execute("DELETE FROM trusted WHERE user_id = ?", (str(target.id),)).rowcount > 0:
                conn.commit()
                await message.reply(f"ğŸ’  **{target.first_name}** Ğ»Ğ¸ÑˆĞµĞ½ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ° 'ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞµĞ½ Ğ³Ğ°Ñ€Ğ°Ğ½Ñ‚Ğ¾Ğ¼'.")
            else: 
                await message.reply("â„¹ï¸ Ğ£ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ½Ğµ Ğ±Ñ‹Ğ»Ğ¾ ÑÑ‚Ğ¾Ğ³Ğ¾ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ°.")
    except Exception as e:
        logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ² ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğµ -Ñ‚Ñ€Ğ°ÑÑ‚: {e}")

@app.on_message(filters.regex(r"(?i)^\+ÑĞ¿Ğ°ÑĞ¸Ğ±Ğ¾") | filters.regex(r"(?i)^\+rep"))
async def add_rep(client, message):
    try:
        if not can_moderate(message.from_user.id, message.from_user.username): 
            return
        parts = message.text.split(maxsplit=1)
        args = parts[1] if len(parts) > 1 else None
        target, _ = await find_target(client, message, args)
        if target:
            if target.id == message.from_user.id: 
                return
            cursor.execute("""
                INSERT INTO reputation (user_id, count) VALUES (?, 1) 
                ON CONFLICT(user_id) DO UPDATE SET count = count + 1
            """, (str(target.id),))
            conn.commit()
            await message.reply(f"ğŸ¤ Ğ ĞµĞ¿ÑƒÑ‚Ğ°Ñ†Ğ¸Ñ **{target.first_name}** Ğ¿Ğ¾Ğ²Ñ‹ÑˆĞµĞ½Ğ°!")
    except Exception as e:
        logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ² ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğµ +rep: {e}")

# ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ ÑĞºĞ°Ğ¼Ğ°
@app.on_message(filters.command(["scam", "ÑĞºĞ°Ğ¼"]))
async def add_scam_cmd(client, message):
    try:
        if not (can_moderate(message.from_user.id, message.from_user.username) or is_volunteer(message.from_user.id)):
            return
        
        if len(message.command) < 4:
            await message.reply("âš ï¸ ĞŸÑ€Ğ¸Ğ¼ĞµÑ€: `/scam @username ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ° Ğ¡ÑÑ‹Ğ»ĞºĞ°`")
            return
        
        target_str = message.command[1]
        target, not_found = await find_target(client, message, target_str)
        
        if not target or not str(target.id).isdigit():
            if not_found:
                await message.reply(f"âŒ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ `{not_found}` Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½.")
            else:
                await message.reply("âŒ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½.")
            return
        
        if is_any_staff(target.id, target.username):
            await message.reply("âŒ ĞĞµĞ»ÑŒĞ·Ñ ÑĞºĞ°Ğ¼ ÑĞ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸ĞºĞ°.")
            return
        
        proof_link = message.command[-1]
        reason = " ".join(message.command[2:-1])
        save_id = str(target.id)
        PENDING_SCAM_ENTRIES[message.from_user.id] = [save_id, reason, proof_link]
        await message.reply(f"âœ… Ğ—Ğ°Ğ½Ğ¾ÑĞ¸Ğ¼ **{target.first_name}**. Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ñ€ĞµĞ¹Ñ‚Ğ¸Ğ½Ğ³:", reply_markup=get_scam_rating_keyboard())
    except Exception as e:
        logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ² ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğµ scam: {e}")
        await message.reply("âŒ ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğ¸ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹.")

@app.on_message(filters.command("unscam"))
async def un_scam_cmd(client, message):
    try:
        if not can_moderate(message.from_user.id, message.from_user.username): 
            return
        
        if len(message.command) < 2:
            await message.reply("âš ï¸ ĞŸÑ€Ğ¸Ğ¼ĞµÑ€: `/unscam @username`")
            return
        
        target_str = message.command[1]
        target, not_found = await find_target(client, message, target_str)
        
        if not target: 
            if not_found:
                await message.reply(f"âŒ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ `{not_found}` Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½.")
            return
        
        save_id = str(target.id)
        if cursor.execute("DELETE FROM scammers WHERE user_id = ?", (save_id,)).rowcount > 0:
            conn.commit()
            await message.reply(f"âœ… **{target_str}** ÑƒĞ´Ğ°Ğ»ĞµĞ½ Ğ¸Ğ· Ğ±Ğ°Ğ·Ñ‹ ÑĞºĞ°Ğ¼ĞµÑ€Ğ¾Ğ².")
        else: 
            await message.reply("â„¹ï¸ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğµ Ğ±Ñ‹Ğ» Ğ² Ğ±Ğ°Ğ·Ğµ ÑĞºĞ°Ğ¼ĞµÑ€Ğ¾Ğ².")
    except Exception as e:
        logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ² ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğµ unscam: {e}")

# ĞĞ±Ñ‰Ğ¸Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ
@app.on_message(filters.text & filters.private & ~filters.regex(r"^\/"))
async def general_private_message_handler(client, message):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº Ğ¾Ğ±Ñ‰Ğ¸Ñ… ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ğ² Ğ»Ğ¸Ñ‡ĞºĞµ"""
    try:
        if len(message.text) > 50: 
            return
        if re.match(r"(?i)^(Ñ‡ĞµĞº|check)\b", message.text.split()[0]): 
            return
        await message.reply("ĞĞ°Ğ¶Ğ¼Ğ¸ /start Ğ´Ğ»Ñ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹.", reply_markup=main_menu_keyboard())
    except Exception as e:
        logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ² Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞµ Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ñ… ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹: {e}")

# Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ±Ğ¾Ñ‚Ğ°
async def main():
    """ĞÑĞ½Ğ¾Ğ²Ğ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°"""
    try:
        print("ğŸš€ Ğ‘Ğ¾Ñ‚ SHARK Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ÑÑ...")
        
        await app.start()
        
        # Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»Ğµ
        await fetch_staff_info()
        
        print("ğŸš€ Ğ‘Ğ¾Ñ‚ SHARK Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½ Ğ¸ Ğ³Ğ¾Ñ‚Ğ¾Ğ² Ğº Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğµ!")
        print("Ğ’Ğ»Ğ°Ğ´ĞµĞ»ÑŒÑ†Ñ‹:")
        for name, data in OWNERS.items():
            print(f"  - {name} (ID: {data['id']}, Username: {data['username'] or 'Ğ½ĞµÑ‚'})")
        
        # ĞĞ¶Ğ¸Ğ´Ğ°ĞµĞ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ
        await idle()
        
    except KeyboardInterrupt:
        print("\nğŸ‘‹ Ğ‘Ğ¾Ñ‚ Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¼.")
    except Exception as e:
        logger.error(f"ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑĞºĞµ Ğ±Ğ¾Ñ‚Ğ°: {e}")
        print(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°: {e}")
    finally:
        try:
            await app.stop()
        except:
            pass
        conn.close()
        print("âœ… Ğ ĞµÑÑƒÑ€ÑÑ‹ Ğ¾ÑĞ²Ğ¾Ğ±Ğ¾Ğ¶Ğ´ĞµĞ½Ñ‹.")

if __name__ == "__main__":
    # Ğ”Ğ»Ñ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾Ğ¹ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ğ² Ñ€Ğ°Ğ·Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ñ… Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸ÑÑ…
    if sys.platform == "win32":
        asyncio.set_event_loop_policy(asyncio.WindowsSelectorEventLoopPolicy())
    
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        print("\nğŸ‘‹ ĞŸÑ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ° Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°.")
    except Exception as e:
        print(f"âŒ ĞĞµĞ¿Ñ€ĞµĞ´Ğ²Ğ¸Ğ´ĞµĞ½Ğ½Ğ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°: {e}")
